name: Keep Supabase Database Alive

on:
  schedule:
    - cron: '0 3 */2 * *'  # Changed to every 2 days instead of 4
  workflow_dispatch:

jobs:
  ping-database:
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Supabase Database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          echo "Starting health check with multiple database operations..."
          
          # Get current timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Operation 1: INSERT a new row
          echo "Operation 1: INSERT"
          HTTP_CODE=$(curl -s -o /tmp/response1.txt -w "%{http_code}" \
            -X POST \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d "{\"created_at\": \"${TIMESTAMP}\"}" \
            "${SUPABASE_URL}/rest/v1/health_check")
          echo "INSERT Response: $HTTP_CODE"
          
          # Operation 2: SELECT all rows
          echo "Operation 2: SELECT"
          HTTP_CODE2=$(curl -s -o /tmp/response2.txt -w "%{http_code}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            "${SUPABASE_URL}/rest/v1/health_check?select=*")
          echo "SELECT Response: $HTTP_CODE2"
          
          # Operation 3: COUNT rows
          echo "Operation 3: COUNT"
          HTTP_CODE3=$(curl -s -o /tmp/response3.txt -w "%{http_code}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Prefer: count=exact" \
            "${SUPABASE_URL}/rest/v1/health_check?select=count")
          echo "COUNT Response: $HTTP_CODE3"
          
          # Operation 4: Another INSERT (just to be extra sure)
          echo "Operation 4: Second INSERT"
          HTTP_CODE4=$(curl -s -o /tmp/response4.txt -w "%{http_code}" \
            -X POST \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d "{\"created_at\": \"${TIMESTAMP}\"}" \
            "${SUPABASE_URL}/rest/v1/health_check")
          echo "Second INSERT Response: $HTTP_CODE4"
          
          # Operation 5: SELECT from applications table (your real table)
          echo "Operation 5: Query applications table"
          HTTP_CODE5=$(curl -s -o /tmp/response5.txt -w "%{http_code}" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            "${SUPABASE_URL}/rest/v1/applications?select=count")
          echo "Applications query Response: $HTTP_CODE5"
          
          echo ""
          echo "âœ“ Completed 5 database operations at: ${TIMESTAMP}"
          echo "This should definitely register as database activity!"

      - name: Report Status
        if: always()
        run: echo "Ping completed at $(date)"
